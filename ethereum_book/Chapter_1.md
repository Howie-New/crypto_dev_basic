<a id="whatis_chapter"></a>

## 什么是以太坊


[上一章：术语](Glossary.md)

"世界计算机"是对以太坊平台最常见的描述。这意味着什么？让我们先从计算机科学的角度来理解，再从实用角度解读以太坊的功能和特性，并将其与比特币及其他分布式账本技术（为简便起见，我们常用"区块链"来统称）进行对比。

从计算机科学的角度看，以太坊是一个确定性但实际上无边界的 State Machine（状态机），具有两个基本功能：一是全局可访问的单例状态，二是能够改变状态的 Virtual Machine（虚拟机）。

从实用角度看，以太坊是一个开源的、全球化的去中心化计算架构，用于执行被称为 Smart Contract（智能合约）的程序。它使用区块链来同步和存储系统状态，并使用名为 Ether（ETH）的加密货币来计量和约束执行资源的成本。

以太坊平台使开发者能够利用内置的经济激励机制构建强大的去中心化应用程序（DApp）。在保证高可用性的同时，还能减少或消除审查风险、第三方依赖和交易对手风险。

<a id="bitcoin_comparison"></a>

### 与比特币的比较


许多有加密货币经验的人会接触以太坊，尤其是比特币用户。以太坊与其他开放式区块链共享许多通用元素：连接参与者的 P2P 网络、用于状态同步的共识算法（以太坊目前使用 Proof of Stake）、原生数字货币（Ether）以及全局账本（Blockchain）。

<a id="blockchain_components"></a>

#### 区块链的组件


开源的公共区块链通常包含以下组件：

* 基于 Gossip 协议的 P2P 网络，用于连接参与者、传播 Transaction（交易）和包含已验证交易的 Block（区块）
* 在 State Machine 中实现的一系列共识规则
* 以 Transaction 形式表示的消息，代表状态转换
* 根据共识规则处理交易的 State Machine
* Blockchain——分布式数据库，记录所有状态转换的日志
* Consensus Algorithm（共识算法），如 Proof of Work，通过让参与者竞争并用共识规则约束他们，从而分散对区块链的控制权
* 上述组件的一个或多个开源软件实现

这些组件通常整合在一个软件客户端中。例如，比特币的参考实现由 Bitcoin Core 开源项目开发，实现为 `bitcoind` 客户端。而以太坊没有单一的参考实现，而是有一份参考规范——即 [Yellow Paper](#yellowpaper) 中对系统的数学描述。多个客户端团队根据这份规范独立开发。

过去，我们用"区块链"这个术语来代指上述所有组件的技术组合。然而如今，"区块链"一词已被营销人员滥用，他们试图炒作项目、为初创公司获取不切实际的估值。这个词本身已变得模糊。我们需要限定词来理解区块链的特征，例如 _开源、公开、全球化、去中心化、中立、抗审查_ 等，以识别这些组件赋予"区块链"系统的重要涌现特性。

并非所有区块链都是相同的。当有人告诉你某个东西是"区块链"时，你还没有得到真正的答案——你需要追问更多问题来澄清它的含义。首先询问上述组件的具体实现，然后确认这个"区块链"是否具备开源、公开等特性。

<a id="ethereum_development"></a>

### 以太坊的开发


以太坊在目标和架构上与之前的开源区块链（包括比特币）有很多不同。

以太坊的主要目的不是作为数字货币支付网络。但原生货币 Ether（ETH）对以太坊的运作至关重要——它被视为一种 Utility Token（实用代币），用于支付使用以太坊平台的费用。

与脚本语言非常有限的比特币不同，以太坊被设计为通用可编程区块链，运行一个能够执行任意复杂代码的 Virtual Machine（虚拟机）。比特币的脚本语言被刻意限制为简单的真/假花费条件判断，而以太坊的语言是 Turing Complete（图灵完备）的——这意味着它相当于一台通用计算机，理论上可以执行图灵机能运行的任何计算。

<a id="ethereum_birth"></a>

### 以太坊的诞生


所有伟大的创新都解决了真实的问题，以太坊也不例外。当人们认识到比特币模型的威力，并试图将其扩展到加密货币之外的应用时，以太坊的构想应运而生。但开发者面临一个两难选择：要么在比特币上层构建，要么启动一条全新的区块链。在比特币上构建意味着要在网络的设计约束内寻找变通方案——有限的数据存储类型和大小限制了可作为 Layer 2 解决方案运行的应用类型。程序员只能使用有限的变量、交易类型和数据集来构建系统。对于需要更大自由度和灵活性的项目，启动新区块链是唯一选择。但从头开始意味着要构建所有基础设施、进行大量测试等。

2013 年底，年轻的程序员和比特币爱好者 Vitalik Buterin 开始思考如何进一步扩展比特币和 Mastercoin（一个在比特币上提供基础 Smart Contract 功能的叠加协议）的能力。2013 年 10 月，Vitalik 向 Mastercoin 团队提出了一个更通用的方案：用灵活的可编程合约（虽然不是 Turing Complete 的）来替代 Mastercoin 的专用合约语言。尽管 Mastercoin 团队印象深刻，但这个提案过于激进，无法纳入他们的开发路线图。

2013 年 12 月，Vitalik 开始分享一份白皮书，描述了以太坊背后的理念：一个 Turing Complete 的可编程通用区块链。数十人看到了这份早期草案，并向 Vitalik 提供反馈，帮助他不断完善提案。

本书的两位作者都收到了白皮书初稿并提出了意见。Andreas M. Antonopoulos 对这个想法非常感兴趣，向 Vitalik 询问了许多问题，包括使用独立区块链实现 Smart Contract 执行的共识规则，以及 Turing Complete 语言的影响等。Andreas 一直关注以太坊的进展，但当时他正在撰写《Mastering Bitcoin》一书的初期阶段，直到很久以后才直接参与以太坊。而 Gavin Wood 博士是最早联系 Vitalik 并贡献 C++ 编程技能的人之一，后来成为以太坊的联合创始人、联合设计师和 CTO。

正如Vitalik在他的 ["Ethereum Prehistory"](https://vitalik.eth.limo/general/2017/09/14/prehistory.html) 中所述:

当时的以太坊协议完全是我自己的创作。然而，从这里开始，新的参与者开始加入。迄今为止协议方面最突出的是Gavin Wood。

...

将以太坊视为"可编程货币"平台的微妙视角转变也归功于 Gavin——基于区块链的合约可以持有数字资产，并根据预设规则在通用计算平台上转移它们。这一变化始于侧重点和术语的细微调整，随着 "Web3" 理念日益受到重视，其影响变得更加深远。Web3 将以太坊视为一套去中心化技术的核心组件，另外两个是 Whisper（消息传递）和 Swarm（存储）。

从 2013 年 12 月开始，Vitalik 和 Gavin 不断完善和发展这个构想，共同构建了以太坊的协议层。

以太坊的创始人们设想的不是一条针对特定目的的区块链，而是一条通过"可编程性"来支持各种应用的通用区块链。核心理念是：通过使用以太坊这样的通用区块链，开发者可以专注于编写自己的应用程序，而无需开发 P2P 网络、区块链、共识算法等底层基础设施。以太坊平台旨在抽象这些底层细节，为去中心化区块链应用提供确定性和安全的编程环境。

就像 Satoshi 一样，Vitalik 和 Gavin 不仅发明了新技术，还以创新的方式将新发明与现有技术结合，并提供原型代码向世界证明他们的想法。

创始人们多年来一直致力于构建和完善这一愿景。2015 年 7 月 30 日，第一个以太坊区块被挖出，"世界计算机"开始服务于全世界……

Vitalik Buterin 于 2017 年 9 月发表的文章《以太坊史前史》提供了以太坊最早期阶段的精彩第一人称视角。

你可以在这里阅读：https://vitalik.eth.limo/general/2017/09/14/prehistory.html

<a id="development_stages"></a>

### 以太坊开发的四个阶段


以太坊的诞生是第一阶段的启动，名为"前沿（Frontier）"。以太坊的发展经历了多个重要阶段和硬分叉，其中最重大的里程碑是2022年9月15日的 **The Merge（合并）**，标志着以太坊从工作量证明（PoW）正式转向权益证明（PoS）。

> **译注**：原书写于2018年，以下开发阶段信息已更新至2026年。

以太坊的重要发展阶段和硬分叉如下：

<a id="past_transitions"></a>

#### 之前的过渡



**Block #0**
: *"Frontier"* - 以太坊的初始阶段, 从2015年7月30日持续到2016年3月。



**Block #200,000**
: "Ice Age" - 引入指数级难度增长的一个难题，激励了到权益证明的过渡。



**Block #1,150,000**
: *"Homestead"* - 以太坊的第二阶段，2016年3月启动。



**Block #1,192,000**
: "DAO" - 恢复被破坏的DAO合约的硬分叉，导致以太坊和以太坊经典分成两个竞争系统。



**Block #2,463,000**
: "Tangerine Whistle" - 调整某些 I/O 密集操作的 Gas 计算方式，并清除利用低 Gas 成本进行 DoS 攻击所累积的状态。



**Block #2,675,000**
: "Spurious Dragon" - 解决更多 DoS 攻击向量，进行另一轮状态清理，并加入 Replay Attack 防护机制。


**Block #4,370,000**
: *"Byzantium（拜占庭）"* - 2017年10月，Metropolis 阶段的第一部分。


**Block #7,280,000**
: *"Constantinople（君士坦丁堡）"* - 2019年2月，Metropolis 阶段的第二部分。


**Block #9,069,000**
: *"Istanbul（伊斯坦布尔）"* - 2019年12月。


**Block #12,244,000**
: *"Berlin（柏林）"* - 2021年4月。


**Block #12,965,000**
: *"London（伦敦）"* - 2021年8月，引入 EIP-1559，改变了 Gas 费用机制。


**Block #15,537,394**
: *"The Merge（合并）"* - 2022年9月15日，以太坊从工作量证明（PoW）转向权益证明（PoS），这是以太坊历史上最重大的升级。


**Slot #6,209,536**
: *"Shanghai/Capella"* - 2023年4月，启用质押 ETH 提款功能。


**Slot #8,626,176**
: *"Cancun/Deneb"* - 2024年3月，引入 Proto-Danksharding（EIP-4844），为 Layer 2 扩容提供支持。

<a id="current_state"></a>

#### 当前状态


以太坊已完成向权益证明的过渡（The Merge）。当前的发展路线图围绕以下几个方向：

- **The Surge**: 通过分片和 Rollup 实现大规模扩容
- **The Scourge**: 抵抗审查和去中心化
- **The Verge**: 通过 Verkle 树简化验证
- **The Purge**: 简化协议，减少历史数据存储需求
- **The Splurge**: 其他改进


<a id="general_purpose_blockchain"></a>

### 以太坊：通用的区块链


最初的区块链（比特币的区块链）追踪比特币单位的状态及其所有权。你可以将比特币视为一个分布式共识 State Machine，其中 Transaction 触发全局的状态转换，从而改变比特币的所有权。状态转换受共识规则约束，使所有参与者最终能在挖出若干区块后就系统的共同（共识）状态达成一致。

以太坊也是一个分布式 State Machine，但它不仅追踪货币所有权状态，还追踪通用数据存储的状态转换。通常指的是任何可以表示为 Key-Value Pair（键值对）的数据。键值存储简单地通过某个键来引用存储的值，例如，用 "Book Title" 键引用值 "Mastering Ethereum"。从某种意义上说，这与通用计算机使用的 RAM（随机存取存储器）数据存储模型具有相同的用途。以太坊有内存来存储代码和数据，并使用区块链来追踪这些内存随时间的变化。就像通用的存储程序计算机一样，以太坊可以将代码加载到其 State Machine 中并运行，将结果状态变化存储在区块链中。与通用计算机的两个重要区别在于：以太坊的状态变化受共识规则约束，且状态通过共享账本在全球分布。以太坊回答了这样一个问题："如果我们追踪任意状态，并对 State Machine 编程，创建一台在共识机制下运行的全球计算机，会怎样？"

<a id="ethereum_components"></a>

### 以太坊的组件


在Ethereum中，[blockchain_components](#blockchain_components) 中描述的区块链系统组件包括：


**P2P Network**
: 以太坊在 _以太坊主网_ 上运行，可以通过TCP端口30303访问，运行称作 _ÐΞVp2p_ 的协议。



**Consensus rules**
: 以太坊的共识规则，在参考规范，即 [yellowpaper](#yellowpaper) 中定义。



**Transactions**
: Ethereum交易（参见[transactions](#transactions)）是网络消息，包括发送者，接收者，值和数据负载等。



**State Machine**
: 以太坊的状态转换由 EVM（Ethereum Virtual Machine，以太坊虚拟机）处理——这是一个执行 Bytecode（字节码）的基于栈的虚拟机。被称为 Smart Contract 的 EVM 程序用高级语言（如 Solidity）编写，并编译为 Bytecode 以在 EVM 上执行。



**Blockchain**
: 以太坊的区块链作为数据库（通常使用 Google 的 LevelDB）存储在每个节点上。区块链使用名为 Merkle Patricia Trie 的序列化哈希数据结构来存储交易和系统状态。



**Consensus Algorithm**
: 以太坊自2022年9月 The Merge 后采用权益证明（Proof-of-Stake）共识机制。验证者需要质押32 ETH来参与区块验证和提议。此前使用的 Ethash 工作量证明算法已被废弃。



**Clients**
: 以太坊采用执行层+共识层的双层客户端架构。执行层客户端包括 _Geth_（Go）、_Nethermind_（C#）、_Besu_（Java）、_Erigon_（Go）；共识层客户端包括 _Prysm_、_Lighthouse_、_Teku_、_Nimbus_、_Lodestar_。运行节点需要同时运行一个执行层客户端和一个共识层客户端。


<a id="references"></a>

#### 其他参考文献


以太坊黄皮书:
https://ethereum.github.io/yellowpaper/paper.pdf

褐皮书：为更广泛的读者以不太正式的语言重写了"黄皮书"：
https://github.com/chronaeon/beigepaper

ÐΞVp2p 网络协议:
https://ethereum.org/en/developers/docs/networking-layer/

以太坊虚拟机 (EVM) 文档:
https://ethereum.org/en/developers/docs/evm/

LevelDB 数据库 (最经常用于存储区块链本地副本):
https://github.com/google/leveldb

Merkle Patricia Trees:
https://ethereum.org/en/developers/docs/data-structures-and-encoding/patricia-merkle-trie/

权益证明共识机制:
https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/

Go-Ethereum (Geth) 客户端:
https://geth.ethereum.org/

Nethermind 客户端:
https://nethermind.io/

Besu 客户端:
https://besu.hyperledger.org/

<a id="turing_completeness"></a>

### 以太坊和图灵完整性


一旦你开始了解以太坊，你会立即听到 "Turing Complete"（图灵完备）这个术语。人们说，与比特币不同，以太坊是 "Turing Complete" 的。这究竟是什么意思？

"Turing Complete" 这个术语以英国数学家 Alan Turing 的名字命名，他被誉为计算机科学之父。1936 年，他创建了一个计算机的数学模型：一个通过读写顺序存储器（类似于无限长的磁带）来操作符号的 State Machine。通过这个构造，Alan Turing 为"通用可计算性"问题（是否所有问题都可以被计算解决）提供了数学基础——答案是否定的。他证明了存在一些不可计算的问题。具体来说，他证明了 Halting Problem（停机问题）——试图判断一个程序是否最终会停止运行——是无解的。

Alan Turing 进一步定义：如果一个系统可以模拟任何图灵机，那么它就是 Turing Complete 的。这样的系统被称为 Universal Turing Machine（UTM，通用图灵机）。

以太坊在 EVM 这个 State Machine 中执行存储的程序，具备在内存中读写数据的能力，这使其成为一个 Turing Complete 系统，因此是一台通用图灵机。在有限存储的约束下，以太坊可以计算任何图灵机能计算的算法。

以太坊的突破性创新在于：将存储程序计算机的通用计算架构与去中心化区块链相结合，从而创建了一台分布式的单状态（Singleton）世界计算机。以太坊程序在"各处"运行，但产生由共识规则保证的共同状态。

<a id="turing_completeness_feature"></a>

#### 图灵完备是一个“特性”


听说以太坊是 Turing Complete 的，你可能会认为这是非 Turing Complete 系统所缺乏的功能。事实恰恰相反——需要刻意努力来限制一个系统使其不是 Turing Complete 的。即使是最简单的 State Machine 也会涌现出 Turing Complete 性。事实上，已知最简单的 Turing Complete State Machine（Rogozhin, 1996）只有 4 个状态、使用 6 个符号，状态定义仅 22 条指令长。

Turing Complete 不仅可以在最简单的系统中实现，而且许多被刻意设计为受限的非 Turing Complete 系统最终被发现是"意外 Turing Complete"的。设计并维护一个非 Turing Complete 的受限系统反而更加困难。

关于"意外 Turing Complete"的有趣参考资料可以在这里找到：
http://beza1e1.tuxen.de/articles/accidentally_turing_complete.html

以太坊是 Turing Complete 的事实意味着任何复杂的程序都可以在以太坊上执行。但这种灵活性也带来了棘手的安全和资源管理问题。

<a id="turing_completeness_implications"></a>

#### 图灵完备的含义


Turing 证明：你无法通过在计算机上模拟程序来预测程序是否会终止。简而言之，我们无法预测程序的执行路径。Turing Complete 系统可以陷入"无限循环"——这是描述永不终止程序的术语（虽然过于简化）。创建一个永不结束的循环程序是很容易的。但由于初始条件和代码之间复杂的相互作用，无意的无限循环可能在毫无预警的情况下出现。

在以太坊中，这带来了一个挑战：每个参与节点（客户端）必须验证每笔交易，运行其调用的所有 Smart Contract。但正如 Turing 所证明的，以太坊无法在不实际运行（可能永远运行）的情况下预测一个 Smart Contract 是否会终止，或会运行多久。可以有意或无意地创建一个 Smart Contract，使其在节点尝试验证时永久运行——这实际上构成 DoS 攻击。当然，在需要毫秒级验证的程序和永远运行的程序之间，存在大量令人头疼的情况：资源浪费、内存膨胀、CPU 过载的程序，这些都只是在消耗资源。在世界计算机上，滥用资源的程序就是在滥用全世界的资源。如果以太坊无法预测资源使用情况，它如何限制 Smart Contract 使用的资源？

为应对这一挑战，以太坊引入了名为 Gas 的计量机制。当 EVM 执行 Smart Contract 时，它会精确计算每条指令（计算、数据访问等）的成本。每条指令都有一个以 Gas 为单位的预定成本。当 Transaction 触发 Smart Contract 执行时，必须附带一定量的 Gas，用于设定该 Smart Contract 可消耗的计算上限。如果计算消耗的 Gas 超过 Transaction 中可用的 Gas，EVM 将终止执行。Gas 是以太坊实现 Turing Complete 计算的同时限制程序资源使用的机制。

2015 年，攻击者利用了一条成本远低于其应有成本的 EVM 指令。这使攻击者能够创建消耗大量内存、需要数分钟才能验证的交易。为解决这一攻击，以太坊不得不通过非向后兼容的更改（Hard Fork）来修改特定指令的 Gas 计费公式。即便如此，以太坊客户端仍然不得不跳过验证这些交易，否则就要花费数周时间来验证它们。

<a id="DApp"></a>

### 从通用区块链到去中心化应用 (DApps)


以太坊最初被设计为一条可用于各种目的的通用区块链。但很快，以太坊的愿景扩展为编程 DApp（Decentralized Application，去中心化应用）的平台。DApp 代表比 "Smart Contract" 更宽广的视角。一个 DApp 至少包含一个 Smart Contract 和一个 Web 用户界面。更广义地说，DApp 是基于开放的、去中心化的、P2P 基础设施服务的 Web 应用程序。

DApp 至少由以下部分组成：

- 区块链上的 Smart Contract
- Web 前端用户界面

此外，许多 DApp 还包含其他去中心化组件，例如：

- 去中心化（P2P）存储协议和平台
- 去中心化（P2P）消息传递协议和平台


> **提示：**
> 你可能会看到 DApp 被拼写为 ÐApp。Ð 是拉丁字符，读作 "ETH"，暗指以太坊。要显示此字符，可在 HTML 中使用十进制实体 `&#208;`，或使用 Unicode 字符 `0xD0`。


<a id="evolving_WWW"></a>

### 万维网的进化


2004 年，"Web 2.0" 这个术语开始流行，用于描述互联网向用户生成内容、响应式界面和交互性的演进。Web 2.0 不是技术规范，而是描述 Web 应用新焦点的术语。

DApp 的概念旨在将万维网引向下一个自然演进阶段——将去中心化的 P2P 协议引入 Web 应用的各个层面。描述这一演进的术语是 Web3，意为 Web 的第三个"版本"。由 Gavin Wood 首先提出，Web3 代表了 Web 应用的新愿景和焦点：从中心化拥有和管理的应用转向基于去中心化协议的应用。

在后面的章节中，我们将探索 web3.js —— 一个将浏览器中运行的 JavaScript 应用与以太坊区块链连接起来的库。

> **译注**：原书提到的 Whisper P2P 消息协议已被弃用，现已被 Waku 取代。Swarm 存储网络目前作为独立项目运行，不再是以太坊核心组件。现代 DApp 开发通常使用 ethers.js 或 viem 等更新的库。

通过在浏览器中运行的 JavaScript 库，开发者可以使用完整的应用开发套件来构建 Web3 DApp：

<a id="web_suite"></a>
![](images/web3suite.png)

<a id="development_culture"></a>

### 以太坊的开发文化


到目前为止，我们讨论了以太坊在目标和技术上与其他区块链（如比特币）的区别。以太坊还有着非常不同的开发文化。

在比特币中，开发遵循保守原则：所有变更都经过仔细研究，以确保不会破坏现有系统。大多数情况下，只有向后兼容的变更才会被采纳。允许现有客户端"选择加入"，但如果他们决定不升级，也能继续运行。

相比之下，以太坊的开发文化强调速度和创新。其信条是 "Move fast and break things"（快速行动，打破常规）。如果需要变更，即使意味着使之前的假设失效、破坏兼容性或强制客户端更新，也会执行。以太坊开发文化的特点是快速创新、快速迭代，以及拥抱实验的意愿。

这对开发者意味着：你必须保持灵活，随时准备在某些基础假设发生变化时重建基础设施。不要假设任何东西是静态或永久的。以太坊开发者面临的一个重大挑战是：代码部署到不可变账本上，而开发平台仍在快速演进之间的内在矛盾。你无法简单地"升级" Smart Contract。你必须准备好部署新合约、迁移用户、应用和资金，然后重新开始。

讽刺的是，这也意味着构建更多自主权、更少中心化控制的系统这一目标是难以实现的。在未来几年，自治和去中心化需要平台具备比以太坊目前更高的稳定性。为了"发展"平台，你必须准备好废弃并重启 Smart Contract，这意味着你必须保留一定程度的控制权。

但积极的一面是，以太坊正在快速发展。几乎没有 Bikeshedding（在无关紧要的细节上争论不休）的机会。如果你开始执着于某个细节，可能会突然发现开发团队已经改变了计划，完全转向了不同的方向。在以太坊，几乎没有神圣不可侵犯的原则、最终标准或固定接口。

最终，以太坊核心协议的开发速度会放缓，接口会变得稳定。但在那之前，创新是驱动原则。你最好跟上节奏，因为没有人会为你放慢脚步。

<a id="why_learn"></a>

### 为什么学习以太坊？


区块链有着非常陡峭的学习曲线，因为它融合了多个学科：编程、信息安全、密码学、经济学、分布式系统、P2P 网络等。以太坊降低了这一学习曲线的陡峭程度，让你可以快速上手。但在看似简单的表面之下，隐藏着更多内容。随着学习的深入，你总会发现新的复杂性和惊喜。

以太坊是学习区块链的绝佳平台，它以比任何其他区块链平台都快的速度构建起了庞大的开发者社区。与其他区块链相比，以太坊是开发者为开发者打造的"开发者的区块链"。熟悉 JavaScript 的开发者可以进入以太坊并快速开始编写可运行的代码。在以太坊的早期，经常能看到 T 恤衫上写着"五行代码创建一个 Token"。当然，这是把双刃剑——编写代码很容易，但编写优质代码和安全代码却非常困难。

<a id="teaching_objectives"></a>

### 本书将教你什么？


本书将深入探讨以太坊的每一个组成部分。你将从一笔简单的 Transaction 开始，分析其工作原理，构建一个简单的 Contract，不断改进它，并追踪它在以太坊系统中的完整生命周期。

你将理解以太坊的工作方式及其设计理念。你将能够理解每个组件的工作原理、它们如何协同工作，以及为什么要这样设计。

[下一章：以太坊基础](Chapter_2.md)

